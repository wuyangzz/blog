<!DOCTYPE html>
<html lang="zh-cn">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="wuyangzz">
  
  
  
  <link rel="prev" href="https://wuyangzz.github.io/2021/arflow%E8%BF%90%E4%BD%9C%E6%AD%A5%E9%AA%A4/" />
  <link rel="next" href="https://wuyangzz.github.io/2021/dicom%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/" />
  <link rel="canonical" href="https://wuyangzz.github.io/2021/unsupraft%E8%BF%90%E8%A1%8C/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           UnSupRAFT运行 | wuyangzz
       
  </title>
  <meta name="title" content="UnSupRAFT运行 | wuyangzz">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/wuyangzz.github.io\/"
    },
    "articleSection" : "posts",
    "name" : "UnSupRAFT运行",
    "headline" : "UnSupRAFT运行",
    "description" : "数据准备 dicom_to_image.py：\nimport cv2 import os import pydicom # dicom图像输入路径 inputdir = \u0026#39;\/workspace\/20210910\/Bmodel\/inputs\u0026#39; # dicom图像输出路径 outdir = \u0026#39;\/workspace\/UnSupRAFT\/datasets\/heart\/\u0026#39; # 获取文件夹下文件列表 files_name_list=os.listdir(inputdir) count=0 # 遍历所有文件 for file_name in files_name_list: path=os.path.join(inputdir,file_name) ds=pydicom.read_file(path) # 获取该文件的帧数 num_frame=ds.pixel_array.shape[0] # 逐帧保存为PNG无损图像 for i in range(num_frame): # if not os.path.exists(os.path.join(outdir,file_name)): # os.makedirs(os.path.join(outdir,file_name)) if i==0: image1 =ds.pixel_array[i, 70:550, 47:751] else: image2 = ds.pixel_array[i, 70:550, 47:751] cv2.imwrite(os.path.join(outdir, str( count)\u002b\u0026#34;_1.png\u0026#34;), image1, [cv2.IMWRITE_PNG_COMPRESSION, 0]) cv2.imwrite(os.path.join(outdir, str( count)\u002b\u0026#34;_2.png\u0026#34;), image2, [cv2.IMWRITE_PNG_COMPRESSION, 0]) image1=image2 count\u002b=1 设置数据集heart_dataset.",
    "inLanguage" : "zh-cn",
    "author" : "wuyangzz",
    "creator" : "wuyangzz",
    "publisher": "wuyangzz",
    "accountablePerson" : "wuyangzz",
    "copyrightHolder" : "wuyangzz",
    "copyrightYear" : "2021",
    "datePublished": "2021-09-29 10:44:43 \u002b0800 CST",
    "dateModified" : "2021-09-29 10:44:43 \u002b0800 CST",
    "url" : "https:\/\/wuyangzz.github.io\/2021\/unsupraft%E8%BF%90%E8%A1%8C\/",
    "wordCount" : "1981",
    "keywords" : [ "", "wuyangzz"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://wuyangzz.github.io/">wuyangzz</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">博客</a>
                
                <a class="menu-item" href="/categories/" title="">分类</a>
                
                <a class="menu-item" href="/tags/" title="">标签</a>
                
                <a class="menu-item" href="/about/" title="关于我">关于我</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://wuyangzz.github.io/">wuyangzz</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">博客</a>
                
                <a class="menu-item" href="/categories/" title="">分类</a>
                
                <a class="menu-item" href="/tags/" title="">标签</a>
                
                <a class="menu-item" href="/about/" title="关于我">关于我</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">UnSupRAFT运行</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://wuyangzz.github.io/" rel="author">wuyangzz</a> with ♥ 
                <span class="post-time">
                on <time datetime=2021-09-29 itemprop="datePublished">September 29, 2021</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://wuyangzz.github.io/categories/">  </a>
                        
                </span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <p>数据准备 <code>dicom_to_image.py</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#f92672">import</span> cv2
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> pydicom

<span style="color:#75715e"># dicom图像输入路径</span>
inputdir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/20210910/Bmodel/inputs&#39;</span>
<span style="color:#75715e"># dicom图像输出路径</span>
outdir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/UnSupRAFT/datasets/heart/&#39;</span>

<span style="color:#75715e"># 获取文件夹下文件列表</span>
files_name_list<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>listdir(inputdir)
count<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#75715e"># 遍历所有文件</span>
<span style="color:#66d9ef">for</span> file_name <span style="color:#f92672">in</span> files_name_list:
    path<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(inputdir,file_name)
    ds<span style="color:#f92672">=</span>pydicom<span style="color:#f92672">.</span>read_file(path)
    <span style="color:#75715e"># 获取该文件的帧数</span>
    num_frame<span style="color:#f92672">=</span>ds<span style="color:#f92672">.</span>pixel_array<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
    <span style="color:#75715e"># 逐帧保存为PNG无损图像</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_frame):
        <span style="color:#75715e"># if not os.path.exists(os.path.join(outdir,file_name)):</span>
        <span style="color:#75715e">#     os.makedirs(os.path.join(outdir,file_name))</span>
        <span style="color:#66d9ef">if</span> i<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>:
            image1 <span style="color:#f92672">=</span>ds<span style="color:#f92672">.</span>pixel_array[i, <span style="color:#ae81ff">70</span>:<span style="color:#ae81ff">550</span>, <span style="color:#ae81ff">47</span>:<span style="color:#ae81ff">751</span>]
        <span style="color:#66d9ef">else</span>:
            image2 <span style="color:#f92672">=</span> ds<span style="color:#f92672">.</span>pixel_array[i, <span style="color:#ae81ff">70</span>:<span style="color:#ae81ff">550</span>, <span style="color:#ae81ff">47</span>:<span style="color:#ae81ff">751</span>]
            cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir, str(
                count)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_1.png&#34;</span>), image1, [cv2<span style="color:#f92672">.</span>IMWRITE_PNG_COMPRESSION, <span style="color:#ae81ff">0</span>])
            cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir, str(
                count)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_2.png&#34;</span>), image2, [cv2<span style="color:#f92672">.</span>IMWRITE_PNG_COMPRESSION, <span style="color:#ae81ff">0</span>])
            image1<span style="color:#f92672">=</span>image2
            count<span style="color:#f92672">+=</span><span style="color:#ae81ff">1</span>

</code></pre></div><p>设置数据集heart_dataset.py</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Data loading based on https://github.com/NVIDIA/flownet2-pytorch</span>

<span style="color:#f92672">from</span> posixpath <span style="color:#f92672">import</span> join
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> torch
<span style="color:#f92672">import</span> torch.utils.data <span style="color:#f92672">as</span> data
<span style="color:#f92672">import</span> torch.nn.functional <span style="color:#f92672">as</span> F
<span style="color:#f92672">import</span> tqdm
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> math
<span style="color:#f92672">import</span> random
<span style="color:#f92672">from</span> glob <span style="color:#f92672">import</span> glob
<span style="color:#f92672">import</span> os.path <span style="color:#f92672">as</span> osp

<span style="color:#f92672">from</span> core.utils <span style="color:#f92672">import</span> frame_utils
<span style="color:#f92672">from</span> core.utils.augmentor <span style="color:#f92672">import</span> FlowAugmentor, SparseFlowAugmentor
<span style="color:#f92672">import</span> albumentations <span style="color:#f92672">as</span> albu
<span style="color:#f92672">from</span> albumentations.pytorch <span style="color:#f92672">import</span> ToTensor


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FlowDataset</span>(data<span style="color:#f92672">.</span>Dataset):
    <span style="color:#66d9ef">def</span> __init__(self, aug_params<span style="color:#f92672">=</span>None, sparse<span style="color:#f92672">=</span>False):
        self<span style="color:#f92672">.</span>augmentor <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>sparse <span style="color:#f92672">=</span> sparse
        <span style="color:#66d9ef">if</span> aug_params <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
            <span style="color:#66d9ef">if</span> sparse:
                self<span style="color:#f92672">.</span>augmentor <span style="color:#f92672">=</span> SparseFlowAugmentor(<span style="color:#f92672">**</span>aug_params)
            <span style="color:#66d9ef">else</span>:
                self<span style="color:#f92672">.</span>augmentor <span style="color:#f92672">=</span> FlowAugmentor(<span style="color:#f92672">**</span>aug_params)

        self<span style="color:#f92672">.</span>is_test <span style="color:#f92672">=</span> False
        self<span style="color:#f92672">.</span>init_seed <span style="color:#f92672">=</span> False
        self<span style="color:#f92672">.</span>flow_list <span style="color:#f92672">=</span> []
        self<span style="color:#f92672">.</span>image_list <span style="color:#f92672">=</span> []
        self<span style="color:#f92672">.</span>extra_info <span style="color:#f92672">=</span> []
        self<span style="color:#f92672">.</span>frames_transforms <span style="color:#f92672">=</span> albu<span style="color:#f92672">.</span>Compose([
            albu<span style="color:#f92672">.</span>Normalize((<span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>), (<span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">1.</span>)),
            ToTensor()
        ])

    <span style="color:#66d9ef">def</span> __getitem__(self, index):

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>is_test:
            img1 <span style="color:#f92672">=</span> frame_utils<span style="color:#f92672">.</span>read_gen(self<span style="color:#f92672">.</span>image_list[index][<span style="color:#ae81ff">0</span>])
            img2 <span style="color:#f92672">=</span> frame_utils<span style="color:#f92672">.</span>read_gen(self<span style="color:#f92672">.</span>image_list[index][<span style="color:#ae81ff">1</span>])
            <span style="color:#75715e"># self</span>
            img1<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>repeat(np<span style="color:#f92672">.</span>array(img1)[:, :, np<span style="color:#f92672">.</span>newaxis], <span style="color:#ae81ff">3</span>, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
            img2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>repeat(np<span style="color:#f92672">.</span>array(img2)[:, :, np<span style="color:#f92672">.</span>newaxis], <span style="color:#ae81ff">3</span>, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
            img1 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(img1)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8)[<span style="color:#f92672">...</span>, :<span style="color:#ae81ff">3</span>]
            img2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(img2)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8)[<span style="color:#f92672">...</span>, :<span style="color:#ae81ff">3</span>]

            img1 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>from_numpy(img1)<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>float()
            img2 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>from_numpy(img2)<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>float()
            <span style="color:#66d9ef">return</span> img1, img2, self<span style="color:#f92672">.</span>extra_info[index]

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>init_seed:
            worker_info <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>get_worker_info()
            <span style="color:#66d9ef">if</span> worker_info <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
                torch<span style="color:#f92672">.</span>manual_seed(worker_info<span style="color:#f92672">.</span>id)
                np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(worker_info<span style="color:#f92672">.</span>id)
                random<span style="color:#f92672">.</span>seed(worker_info<span style="color:#f92672">.</span>id)
                self<span style="color:#f92672">.</span>init_seed <span style="color:#f92672">=</span> True

        index <span style="color:#f92672">=</span> index <span style="color:#f92672">%</span> len(self<span style="color:#f92672">.</span>image_list)
        valid <span style="color:#f92672">=</span> None
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>sparse:
            flow, valid <span style="color:#f92672">=</span> frame_utils<span style="color:#f92672">.</span>readFlowKITTI(self<span style="color:#f92672">.</span>flow_list[index])
        <span style="color:#66d9ef">else</span>:
            flow <span style="color:#f92672">=</span> frame_utils<span style="color:#f92672">.</span>read_gen(self<span style="color:#f92672">.</span>flow_list[index])

        img1 <span style="color:#f92672">=</span> frame_utils<span style="color:#f92672">.</span>read_gen(self<span style="color:#f92672">.</span>image_list[index][<span style="color:#ae81ff">0</span>])
        img2 <span style="color:#f92672">=</span> frame_utils<span style="color:#f92672">.</span>read_gen(self<span style="color:#f92672">.</span>image_list[index][<span style="color:#ae81ff">1</span>])

        flow <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(flow)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float32)
        img1 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(img1)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8)
        img2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(img2)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8)

        frame1 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>frames_transforms(image<span style="color:#f92672">=</span>img1)[<span style="color:#e6db74">&#39;image&#39;</span>]
        frame2 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>frames_transforms(image<span style="color:#f92672">=</span>img2)[<span style="color:#e6db74">&#39;image&#39;</span>]

        <span style="color:#75715e"># import cv2</span>
        <span style="color:#75715e"># cv2.imshow(&#39;image1&#39;, img1)</span>
        <span style="color:#75715e"># cv2.imshow(&#39;image2&#39;, img2)</span>
        <span style="color:#75715e"># cv2.waitKey(-1)</span>

        <span style="color:#75715e"># grayscale images</span>
        <span style="color:#66d9ef">if</span> len(img1<span style="color:#f92672">.</span>shape) <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
            img1 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>tile(img1[<span style="color:#f92672">...</span>, None], (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>))
            img2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>tile(img2[<span style="color:#f92672">...</span>, None], (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>))
        <span style="color:#66d9ef">else</span>:
            img1 <span style="color:#f92672">=</span> img1[<span style="color:#f92672">...</span>, :<span style="color:#ae81ff">3</span>]
            img2 <span style="color:#f92672">=</span> img2[<span style="color:#f92672">...</span>, :<span style="color:#ae81ff">3</span>]

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>augmentor <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>sparse:
                img1, img2, flow, valid <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>augmentor(
                    img1, img2, flow, valid)
            <span style="color:#66d9ef">else</span>:
                img1, img2, flow <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>augmentor(img1, img2, flow)

        img1 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>from_numpy(img1)<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>float()
        img2 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>from_numpy(img2)<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>float()
        flow <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>from_numpy(flow)<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>float()

        <span style="color:#66d9ef">if</span> valid <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
            valid <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>from_numpy(valid)
        <span style="color:#66d9ef">else</span>:
            valid <span style="color:#f92672">=</span> (flow[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>abs() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span>) <span style="color:#f92672">&amp;</span> (flow[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>abs() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span>)

        <span style="color:#66d9ef">return</span> img1, img2, flow, valid<span style="color:#f92672">.</span>float(), frame1, frame2

    <span style="color:#66d9ef">def</span> __rmul__(self, v):
        self<span style="color:#f92672">.</span>flow_list <span style="color:#f92672">=</span> v <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>flow_list
        self<span style="color:#f92672">.</span>image_list <span style="color:#f92672">=</span> v <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>image_list
        <span style="color:#66d9ef">return</span> self

    <span style="color:#66d9ef">def</span> __len__(self):
        <span style="color:#66d9ef">return</span> len(self<span style="color:#f92672">.</span>image_list)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HeartDataset</span>(FlowDataset):
    <span style="color:#66d9ef">def</span> __init__(self, aug_params<span style="color:#f92672">=</span>None, split<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;testing&#39;</span>, root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;datasets/heart&#39;</span>):
        super(HeartDataset, self)<span style="color:#f92672">.</span>__init__(aug_params, sparse<span style="color:#f92672">=</span>True)
        <span style="color:#66d9ef">if</span> split <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;testing&#39;</span>:
            self<span style="color:#f92672">.</span>is_test <span style="color:#f92672">=</span> True
        root <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;/workspace/UnSupRAFT&#39;</span>, root)
        images1 <span style="color:#f92672">=</span> sorted(glob(osp<span style="color:#f92672">.</span>join(root, <span style="color:#e6db74">&#39;*_1.png&#39;</span>)))
        images2 <span style="color:#f92672">=</span> sorted(glob(osp<span style="color:#f92672">.</span>join(root, <span style="color:#e6db74">&#39;*_2.png&#39;</span>)))
        <span style="color:#f92672">import</span> sys
        sys<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;UnSupRAFT&#39;</span>)
        <span style="color:#66d9ef">for</span> img1, img2 <span style="color:#f92672">in</span> zip(images1, images2):
            frame_id <span style="color:#f92672">=</span> img1<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
            self<span style="color:#f92672">.</span>extra_info <span style="color:#f92672">+=</span> [[frame_id]]
            self<span style="color:#f92672">.</span>image_list <span style="color:#f92672">+=</span> [[img1, img2]]


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fetch_dataloader</span>(args, TRAIN_DS<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;C+T+K+S+H&#39;</span>):
    <span style="color:#e6db74">&#34;&#34;&#34; Create the data loader for the corresponding trainign set &#34;&#34;&#34;</span>

    train_dataset <span style="color:#f92672">=</span> HeartDataset()

    train_loader <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(train_dataset,
                                   batch_size<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>batch_size,
                                   pin_memory<span style="color:#f92672">=</span>False,
                                   shuffle<span style="color:#f92672">=</span>True,
                                   num_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>,
                                   drop_last<span style="color:#f92672">=</span>True)

    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Training with </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> image pairs&#39;</span> <span style="color:#f92672">%</span> len(train_dataset))
    <span style="color:#66d9ef">return</span> train_loader

<span style="color:#75715e"># 测试数据集</span>
<span style="color:#66d9ef">if</span> __name__<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;__main__&#39;</span>:
    aug_params <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;crop_size&#39;</span>: [<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">512</span>],
        <span style="color:#e6db74">&#39;min_scale&#39;</span>: <span style="color:#f92672">-</span><span style="color:#ae81ff">0.2</span>,
        <span style="color:#e6db74">&#39;max_scale&#39;</span>: <span style="color:#ae81ff">0.4</span>,
        <span style="color:#e6db74">&#39;do_flip&#39;</span>: False
    }
    train_dataset <span style="color:#f92672">=</span> HeartDataset(aug_params)
    train_loader <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(train_dataset,
                                   batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
                                   pin_memory<span style="color:#f92672">=</span>True,
                                   shuffle<span style="color:#f92672">=</span>True,
                                   num_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
                                   drop_last<span style="color:#f92672">=</span>True)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Training with </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> image pairs&#39;</span> <span style="color:#f92672">%</span> len(train_dataset))
    <span style="color:#66d9ef">for</span> batch_ndx, sample <span style="color:#f92672">in</span> enumerate(train_loader):
        image1<span style="color:#f92672">=</span>sample[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>cuda()
        image2<span style="color:#f92672">=</span>sample[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>cuda()
        id<span style="color:#f92672">=</span>sample[<span style="color:#ae81ff">2</span>]
        <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> sample:
            <span style="color:#66d9ef">print</span>(x)
        <span style="color:#66d9ef">print</span>(sample<span style="color:#f92672">.</span>inp<span style="color:#f92672">.</span>is_pinned())
        <span style="color:#66d9ef">print</span>(sample<span style="color:#f92672">.</span>tgt<span style="color:#f92672">.</span>is_pinned())
</code></pre></div><p>运行文件hear_train.py</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> print_function, division
<span style="color:#f92672">import</span> sys
<span style="color:#75715e"># sys.path.append(&#39;&lt;core_path&gt;&#39;)</span>
<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">python -u train.py --name raft-chairs --stage chairs --validation chairs 
</span><span style="color:#e6db74">--gpus 0 --num_steps 100000 --batch_size 8 --lr 0.0004 --image_size 368 496 --wdecay 0.0001
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>

<span style="color:#f92672">import</span> argparse
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> cv2
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt

<span style="color:#f92672">import</span> torch
<span style="color:#f92672">import</span> torch.nn <span style="color:#f92672">as</span> nn
<span style="color:#f92672">import</span> torch.optim <span style="color:#f92672">as</span> optim
<span style="color:#f92672">import</span> torch.nn.functional <span style="color:#f92672">as</span> F

<span style="color:#f92672">from</span> torch.utils.data <span style="color:#f92672">import</span> DataLoader
<span style="color:#f92672">import</span> sys

sys<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;core&#39;</span>)
<span style="color:#f92672">from</span> raft <span style="color:#f92672">import</span> RAFT
<span style="color:#f92672">import</span> evaluate
<span style="color:#f92672">from</span> core <span style="color:#f92672">import</span> datasets
<span style="color:#f92672">from</span> tqdm <span style="color:#f92672">import</span> tqdm

<span style="color:#f92672">from</span> torch.utils.tensorboard <span style="color:#f92672">import</span> SummaryWriter
<span style="color:#f92672">from</span> core.utils.unsupervised_loss <span style="color:#f92672">import</span> unsup_loss
<span style="color:#f92672">import</span> heart_dataset

<span style="color:#66d9ef">try</span>:
    <span style="color:#f92672">from</span> torch.cuda.amp <span style="color:#f92672">import</span> GradScaler
<span style="color:#66d9ef">except</span>:
    <span style="color:#75715e"># dummy GradScaler for PyTorch &lt; 1.6</span>
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GradScaler</span>:
        <span style="color:#66d9ef">def</span> __init__(self):
            <span style="color:#66d9ef">pass</span>

        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">scale</span>(self, loss):
            <span style="color:#66d9ef">return</span> loss

        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">unscale_</span>(self, optimizer):
            <span style="color:#66d9ef">pass</span>

        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">step</span>(self, optimizer):
            optimizer<span style="color:#f92672">.</span>step()

        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update</span>(self):
            <span style="color:#66d9ef">pass</span>


<span style="color:#75715e"># exclude extremly large displacements</span>
MAX_FLOW <span style="color:#f92672">=</span> <span style="color:#ae81ff">400</span>
SUM_FREQ <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
VAL_FREQ <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sequence_loss</span>(flow_preds, warped_images, img1, total_steps, gamma<span style="color:#f92672">=</span><span style="color:#ae81ff">0.8</span>, max_flow<span style="color:#f92672">=</span>MAX_FLOW):
    <span style="color:#e6db74">&#34;&#34;&#34; Loss function defined over sequence of flow predictions &#34;&#34;&#34;</span>

    n_predictions <span style="color:#f92672">=</span> len(flow_preds)
    flow_loss <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>

    <span style="color:#75715e"># exlude invalid pixels and extremely large diplacements</span>
    <span style="color:#75715e"># mag = torch.sum(flow_gt**2, dim=1).sqrt()</span>

    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n_predictions):
        i_weight <span style="color:#f92672">=</span> gamma<span style="color:#f92672">**</span>(n_predictions <span style="color:#f92672">-</span> i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)

        <span style="color:#75715e"># if total_steps &lt; 0:</span>
        <span style="color:#75715e">#     i_loss = (flow_preds[i] - flow_gt).abs()</span>
        <span style="color:#75715e"># else:</span>
        i_loss <span style="color:#f92672">=</span> unsup_loss(flow_preds[i], warped_images[i], img1)

        flow_loss <span style="color:#f92672">+=</span> i_weight <span style="color:#f92672">*</span> (i_loss)<span style="color:#f92672">.</span>mean()

    <span style="color:#75715e"># epe = torch.sum((flow_preds[-1] - flow_gt)**2, dim=1).sqrt()</span>
    <span style="color:#75715e"># epe = epe.view(-1)</span>

    metrics <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;loss&#39;</span>: flow_loss<span style="color:#f92672">.</span>item()
    }

    <span style="color:#66d9ef">return</span> flow_loss, metrics


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">count_parameters</span>(model):
    <span style="color:#66d9ef">return</span> sum(p<span style="color:#f92672">.</span>numel() <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> model<span style="color:#f92672">.</span>parameters() <span style="color:#66d9ef">if</span> p<span style="color:#f92672">.</span>requires_grad)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fetch_optimizer</span>(args, model):
    <span style="color:#e6db74">&#34;&#34;&#34; Create the optimizer and learning rate scheduler &#34;&#34;&#34;</span>
    optimizer <span style="color:#f92672">=</span> optim<span style="color:#f92672">.</span>AdamW(model<span style="color:#f92672">.</span>parameters(),
                            lr<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>lr,
                            weight_decay<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>wdecay,
                            eps<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>epsilon)

    scheduler <span style="color:#f92672">=</span> optim<span style="color:#f92672">.</span>lr_scheduler<span style="color:#f92672">.</span>OneCycleLR(optimizer,
                                              args<span style="color:#f92672">.</span>lr,
                                              args<span style="color:#f92672">.</span>num_steps <span style="color:#f92672">+</span> <span style="color:#ae81ff">100</span>,
                                              pct_start<span style="color:#f92672">=</span><span style="color:#ae81ff">0.05</span>,
                                              cycle_momentum<span style="color:#f92672">=</span>False,
                                              anneal_strategy<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;linear&#39;</span>)

    <span style="color:#66d9ef">return</span> optimizer, scheduler


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Logger</span>:
    <span style="color:#66d9ef">def</span> __init__(self, model, scheduler):
        self<span style="color:#f92672">.</span>model <span style="color:#f92672">=</span> model
        self<span style="color:#f92672">.</span>scheduler <span style="color:#f92672">=</span> scheduler
        self<span style="color:#f92672">.</span>total_steps <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>running_loss <span style="color:#f92672">=</span> {}
        self<span style="color:#f92672">.</span>writer <span style="color:#f92672">=</span> None

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_print_training_status</span>(self):
        metrics_data <span style="color:#f92672">=</span> [
            self<span style="color:#f92672">.</span>running_loss[k] <span style="color:#f92672">/</span> SUM_FREQ
            <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> sorted(self<span style="color:#f92672">.</span>running_loss<span style="color:#f92672">.</span>keys())
        ]
        training_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;[{:6d}, {:10.7f}] &#34;</span><span style="color:#f92672">.</span>format(
            self<span style="color:#f92672">.</span>total_steps <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
            self<span style="color:#f92672">.</span>scheduler<span style="color:#f92672">.</span>get_last_lr()[<span style="color:#ae81ff">0</span>])
        metrics_str <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;{:10.4f}, &#34;</span> <span style="color:#f92672">*</span> len(metrics_data))<span style="color:#f92672">.</span>format(<span style="color:#f92672">*</span>metrics_data)

        <span style="color:#75715e"># print the training status</span>
        <span style="color:#66d9ef">print</span>(training_str <span style="color:#f92672">+</span> metrics_str)

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>writer <span style="color:#f92672">is</span> None:
            self<span style="color:#f92672">.</span>writer <span style="color:#f92672">=</span> SummaryWriter()

        <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>running_loss:
            self<span style="color:#f92672">.</span>writer<span style="color:#f92672">.</span>add_scalar(k, self<span style="color:#f92672">.</span>running_loss[k] <span style="color:#f92672">/</span> SUM_FREQ,
                                   self<span style="color:#f92672">.</span>total_steps)
            self<span style="color:#f92672">.</span>running_loss[k] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">push</span>(self, metrics):
        self<span style="color:#f92672">.</span>total_steps <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

        <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> metrics:
            <span style="color:#66d9ef">if</span> key <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>running_loss:
                self<span style="color:#f92672">.</span>running_loss[key] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>

            self<span style="color:#f92672">.</span>running_loss[key] <span style="color:#f92672">+=</span> metrics[key]

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>total_steps <span style="color:#f92672">%</span> SUM_FREQ <span style="color:#f92672">==</span> SUM_FREQ <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>:
            self<span style="color:#f92672">.</span>_print_training_status()
            self<span style="color:#f92672">.</span>running_loss <span style="color:#f92672">=</span> {}

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_dict</span>(self, results):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>writer <span style="color:#f92672">is</span> None:
            self<span style="color:#f92672">.</span>writer <span style="color:#f92672">=</span> SummaryWriter()

        <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> results:
            self<span style="color:#f92672">.</span>writer<span style="color:#f92672">.</span>add_scalar(key, results[key], self<span style="color:#f92672">.</span>total_steps)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">close</span>(self):
        self<span style="color:#f92672">.</span>writer<span style="color:#f92672">.</span>close()


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(args):

    model <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>DataParallel(RAFT(args), device_ids<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>gpus)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Parameter Count: </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> count_parameters(model))

    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>restore_ckpt <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
        model<span style="color:#f92672">.</span>load_state_dict(torch<span style="color:#f92672">.</span>load(args<span style="color:#f92672">.</span>restore_ckpt), strict<span style="color:#f92672">=</span>False)

    model<span style="color:#f92672">.</span>cuda()
    model<span style="color:#f92672">.</span>train()

    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>stage <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;chairs&#39;</span>:
        model<span style="color:#f92672">.</span>module<span style="color:#f92672">.</span>freeze_bn()

    train_loader <span style="color:#f92672">=</span> heart_dataset<span style="color:#f92672">.</span>fetch_dataloader(args)
    optimizer, scheduler <span style="color:#f92672">=</span> fetch_optimizer(args, model)

    total_steps <span style="color:#f92672">=</span> <span style="color:#ae81ff">95000</span>
    scaler <span style="color:#f92672">=</span> GradScaler(enabled<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>mixed_precision)
    logger <span style="color:#f92672">=</span> Logger(model, scheduler)

    VAL_FREQ <span style="color:#f92672">=</span> <span style="color:#ae81ff">5000</span>
    add_noise <span style="color:#f92672">=</span> True

    should_keep_training <span style="color:#f92672">=</span> True
    <span style="color:#66d9ef">while</span> should_keep_training:

        <span style="color:#66d9ef">for</span> i_batch, data_blob <span style="color:#f92672">in</span> tqdm(enumerate(train_loader),
                                       total<span style="color:#f92672">=</span>len(train_loader)):
            optimizer<span style="color:#f92672">.</span>zero_grad()
            image1 <span style="color:#f92672">=</span> data_blob[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>cuda()
            image2 <span style="color:#f92672">=</span> data_blob[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>cuda()
            id <span style="color:#f92672">=</span> data_blob[<span style="color:#ae81ff">2</span>]
            <span style="color:#75715e"># image1, image2 = [</span>
            <span style="color:#75715e">#     x for x in data_blob</span>
            <span style="color:#75715e"># ]</span>

            <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>add_noise:
                stdv <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>uniform(<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">5.0</span>)
                image1 <span style="color:#f92672">=</span> (image1 <span style="color:#f92672">+</span>
                          stdv <span style="color:#f92672">*</span> torch<span style="color:#f92672">.</span>randn(<span style="color:#f92672">*</span>image1<span style="color:#f92672">.</span>shape)<span style="color:#f92672">.</span>cuda())<span style="color:#f92672">.</span>clamp(
                              <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">255.0</span>)
                image2 <span style="color:#f92672">=</span> (image2 <span style="color:#f92672">+</span>
                          stdv <span style="color:#f92672">*</span> torch<span style="color:#f92672">.</span>randn(<span style="color:#f92672">*</span>image2<span style="color:#f92672">.</span>shape)<span style="color:#f92672">.</span>cuda())<span style="color:#f92672">.</span>clamp(
                              <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">255.0</span>)
    <span style="color:#75715e">#             def forward(self, image1, image2, flow_gt=None, frame1=None, frame2=None, \</span>
    <span style="color:#75715e">#  iters=12, flow_init=None, upsample=True, test_mode=False):</span>
            flow_predictions, warped_images <span style="color:#f92672">=</span> model(image1, image2, iters<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>iters)

            loss, metrics <span style="color:#f92672">=</span> sequence_loss(flow_predictions, \
             warped_images,  image1, total_steps<span style="color:#f92672">=</span>total_steps, gamma<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>gamma)

            scaler<span style="color:#f92672">.</span>scale(loss)<span style="color:#f92672">.</span>backward()
            scaler<span style="color:#f92672">.</span>unscale_(optimizer)
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>clip_grad_norm_(model<span style="color:#f92672">.</span>parameters(), args<span style="color:#f92672">.</span>clip)

            scaler<span style="color:#f92672">.</span>step(optimizer)
            scheduler<span style="color:#f92672">.</span>step()
            scaler<span style="color:#f92672">.</span>update()

            logger<span style="color:#f92672">.</span>push(metrics)
            <span style="color:#75715e"># print(total_steps, total_steps % VAL_FREQ)</span>
            <span style="color:#66d9ef">if</span> total_steps <span style="color:#f92672">%</span> VAL_FREQ <span style="color:#f92672">==</span> VAL_FREQ <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>:
                PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;checkpoints/heart/</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">_</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">.pth&#39;</span> <span style="color:#f92672">%</span> (total_steps <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
                                                         args<span style="color:#f92672">.</span>name)
                torch<span style="color:#f92672">.</span>save(model<span style="color:#f92672">.</span>state_dict(), PATH)

                <span style="color:#75715e"># results = {}</span>
                <span style="color:#75715e"># for val_dataset in args.validation:</span>
                <span style="color:#75715e">#     if val_dataset == &#39;chairs&#39;:</span>
                <span style="color:#75715e">#         results.update(evaluate.validate_chairs(model.module))</span>
                <span style="color:#75715e">#     elif val_dataset == &#39;sintel&#39;:</span>
                <span style="color:#75715e">#         results.update(evaluate.validate_sintel(model.module))</span>
                <span style="color:#75715e">#     elif val_dataset == &#39;kitti&#39;:</span>
                <span style="color:#75715e">#         results.update(evaluate.validate_kitti(model.module))</span>

                <span style="color:#75715e"># logger.write_dict(results)</span>

                model<span style="color:#f92672">.</span>train()
                <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>stage <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;chairs&#39;</span>:
                    model<span style="color:#f92672">.</span>module<span style="color:#f92672">.</span>freeze_bn()

            total_steps <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

            <span style="color:#66d9ef">if</span> total_steps <span style="color:#f92672">&gt;</span> args<span style="color:#f92672">.</span>num_steps:
                should_keep_training <span style="color:#f92672">=</span> False
                <span style="color:#66d9ef">break</span>

    logger<span style="color:#f92672">.</span>close()
    PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;checkpoints/</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">.pth&#39;</span> <span style="color:#f92672">%</span> args<span style="color:#f92672">.</span>name
    torch<span style="color:#f92672">.</span>save(model<span style="color:#f92672">.</span>state_dict(), PATH)

    <span style="color:#66d9ef">return</span> PATH


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--name&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;raft&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;name your experiment&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--stage&#39;</span>,
                        default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;heart&#39;</span>,
                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;determines which dataset to use for training&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--restore_ckpt&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;restore checkpoint&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--small&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;use small model&#39;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--validation&#39;</span>, type<span style="color:#f92672">=</span>str, nargs<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;+&#39;</span>)

    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--lr&#39;</span>, type<span style="color:#f92672">=</span>float, default<span style="color:#f92672">=</span><span style="color:#ae81ff">0.00002</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--num_steps&#39;</span>, type<span style="color:#f92672">=</span>int, default<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--batch_size&#39;</span>, type<span style="color:#f92672">=</span>int, default<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--image_size&#39;</span>,
                        type<span style="color:#f92672">=</span>int,
                        nargs<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;+&#39;</span>,
                        default<span style="color:#f92672">=</span>[<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">512</span>])
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--gpus&#39;</span>, type<span style="color:#f92672">=</span>int, nargs<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;+&#39;</span>, default<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>])
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--mixed_precision&#39;</span>,
                        action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>,
                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;use mixed precision&#39;</span>)

    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--iters&#39;</span>, type<span style="color:#f92672">=</span>int, default<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--wdecay&#39;</span>, type<span style="color:#f92672">=</span>float, default<span style="color:#f92672">=.</span><span style="color:#ae81ff">00005</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--epsilon&#39;</span>, type<span style="color:#f92672">=</span>float, default<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-8</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--clip&#39;</span>, type<span style="color:#f92672">=</span>float, default<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--dropout&#39;</span>, type<span style="color:#f92672">=</span>float, default<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--gamma&#39;</span>,
                        type<span style="color:#f92672">=</span>float,
                        default<span style="color:#f92672">=</span><span style="color:#ae81ff">0.8</span>,
                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;exponential weighting&#39;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--add_noise&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>)
    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()

    torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">1234</span>)
    np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">1234</span>)

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(<span style="color:#e6db74">&#39;checkpoints&#39;</span>):
        os<span style="color:#f92672">.</span>mkdir(<span style="color:#e6db74">&#39;checkpoints&#39;</span>)

    train(args)
</code></pre></div><p>修改raft.py</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, image1, image2, flow_gt, frame1, frame2, \
	 	iters<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>, flow_init<span style="color:#f92672">=</span>None, upsample<span style="color:#f92672">=</span>True, test_mode<span style="color:#f92672">=</span>False):

<span style="color:#75715e">#修改为</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, image1, image2, flow_gt<span style="color:#f92672">=</span>None, frame1<span style="color:#f92672">=</span>None, frame2<span style="color:#f92672">=</span>None, \
     iters<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>, flow_init<span style="color:#f92672">=</span>None, upsample<span style="color:#f92672">=</span>True, test_mode<span style="color:#f92672">=</span>False):
</code></pre></div><p>#预测代码修改evaluate.py</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> sys
sys<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;core&#39;</span>)

<span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
<span style="color:#f92672">import</span> argparse
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> torch
<span style="color:#f92672">import</span> torch.nn.functional <span style="color:#f92672">as</span> F
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt

<span style="color:#f92672">from</span> core <span style="color:#f92672">import</span> datasets
<span style="color:#f92672">from</span> utils <span style="color:#f92672">import</span> flow_viz
<span style="color:#f92672">from</span> utils <span style="color:#f92672">import</span> frame_utils

<span style="color:#f92672">from</span> raft <span style="color:#f92672">import</span> RAFT
<span style="color:#f92672">from</span> utils.utils <span style="color:#f92672">import</span> InputPadder, forward_interpolate
<span style="color:#f92672">from</span> tqdm <span style="color:#f92672">import</span> tqdm
<span style="color:#f92672">from</span> scipy.special <span style="color:#f92672">import</span> softmax
<span style="color:#f92672">import</span> cv2
<span style="color:#f92672">import</span> pickle


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">viz</span>(img, flows, val_id):
    img <span style="color:#f92672">=</span> img[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()
    new_flows <span style="color:#f92672">=</span> []

    <span style="color:#66d9ef">for</span> flo <span style="color:#f92672">in</span> flows:
        <span style="color:#66d9ef">try</span>:
            flo <span style="color:#f92672">=</span> flo[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()
        <span style="color:#66d9ef">except</span>:
            flo <span style="color:#f92672">=</span> flo<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()
        flo <span style="color:#f92672">=</span> flow_viz<span style="color:#f92672">.</span>flow_to_image(flo)
        new_flows<span style="color:#f92672">.</span>append(flo)

    img_flo <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>concatenate([img, <span style="color:#f92672">*</span>new_flows], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)

    img <span style="color:#f92672">=</span> img_flo[:, :, [<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>]]<span style="color:#75715e">#/255.0</span>
    cv2<span style="color:#f92672">.</span>imwrite(f<span style="color:#e6db74">&#39;outputs/{val_id}.png&#39;</span>, img)

    img <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255.0</span>
    <span style="color:#75715e"># cv2.imshow(&#39;image&#39;, img)</span>
    <span style="color:#75715e"># cv2.waitKey()</span>
    <span style="color:#75715e"># cv2.destroyAllWindows()</span>


<span style="color:#a6e22e">@torch.no_grad</span>()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_sintel_submission</span>(model, iters<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, warm_start<span style="color:#f92672">=</span>False, output_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sintel_submission&#39;</span>):
    <span style="color:#e6db74">&#34;&#34;&#34; Create submission for the Sintel leaderboard &#34;&#34;&#34;</span>
    model<span style="color:#f92672">.</span>eval()
    <span style="color:#66d9ef">for</span> dstype <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;clean&#39;</span>, <span style="color:#e6db74">&#39;final&#39;</span>]:
        test_dataset <span style="color:#f92672">=</span> datasets<span style="color:#f92672">.</span>MpiSintel(split<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test&#39;</span>, aug_params<span style="color:#f92672">=</span>None, dstype<span style="color:#f92672">=</span>dstype)

        flow_prev, sequence_prev <span style="color:#f92672">=</span> None, None
        <span style="color:#66d9ef">for</span> test_id <span style="color:#f92672">in</span> tqdm(range(len(test_dataset))):
            image1, image2, (sequence, frame) <span style="color:#f92672">=</span> test_dataset[test_id]
            <span style="color:#66d9ef">if</span> sequence <span style="color:#f92672">!=</span> sequence_prev:
                flow_prev <span style="color:#f92672">=</span> None

            padder <span style="color:#f92672">=</span> InputPadder(image1<span style="color:#f92672">.</span>shape)
            image1, image2 <span style="color:#f92672">=</span> padder<span style="color:#f92672">.</span>pad(image1[None]<span style="color:#f92672">.</span>cuda(), image2[None]<span style="color:#f92672">.</span>cuda())

            flow_low, flow_pr <span style="color:#f92672">=</span> model(image1, image2, \
             frame1<span style="color:#f92672">=</span>None, frame2<span style="color:#f92672">=</span>None, flow_gt<span style="color:#f92672">=</span>None, \
             iters<span style="color:#f92672">=</span>iters, flow_init<span style="color:#f92672">=</span>flow_prev, test_mode<span style="color:#f92672">=</span>True)
            flow <span style="color:#f92672">=</span> padder<span style="color:#f92672">.</span>unpad(flow_pr[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()

            <span style="color:#66d9ef">if</span> warm_start:
                flow_prev <span style="color:#f92672">=</span> forward_interpolate(flow_low[<span style="color:#ae81ff">0</span>])[None]<span style="color:#f92672">.</span>cuda()

            output_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(output_path, dstype, sequence)
            output_file <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(output_dir, <span style="color:#e6db74">&#39;frame</span><span style="color:#e6db74">%04d</span><span style="color:#e6db74">.flo&#39;</span> <span style="color:#f92672">%</span> (frame<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>))

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(output_dir):
                os<span style="color:#f92672">.</span>makedirs(output_dir)

            frame_utils<span style="color:#f92672">.</span>writeFlow(output_file, flow)
            sequence_prev <span style="color:#f92672">=</span> sequence


<span style="color:#a6e22e">@torch.no_grad</span>()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_kitti_submission</span>(model, iters<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>, output_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kitti_submission&#39;</span>):
    <span style="color:#e6db74">&#34;&#34;&#34; Create submission for the Sintel leaderboard &#34;&#34;&#34;</span>
    model<span style="color:#f92672">.</span>eval()
    test_dataset <span style="color:#f92672">=</span> datasets<span style="color:#f92672">.</span>KITTI(split<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;testing&#39;</span>, aug_params<span style="color:#f92672">=</span>None)

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(output_path):
        os<span style="color:#f92672">.</span>makedirs(output_path)

    <span style="color:#66d9ef">for</span> test_id <span style="color:#f92672">in</span> range(len(test_dataset)):
        image1, image2, (frame_id, ) <span style="color:#f92672">=</span> test_dataset[test_id]
        padder <span style="color:#f92672">=</span> InputPadder(image1<span style="color:#f92672">.</span>shape, mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kitti&#39;</span>)
        image1, image2 <span style="color:#f92672">=</span> padder<span style="color:#f92672">.</span>pad(image1[None]<span style="color:#f92672">.</span>cuda(), image2[None]<span style="color:#f92672">.</span>cuda())

        _, flow_pr <span style="color:#f92672">=</span> model(image1, image2, iters<span style="color:#f92672">=</span>iters, test_mode<span style="color:#f92672">=</span>True)
        flow <span style="color:#f92672">=</span> padder<span style="color:#f92672">.</span>unpad(flow_pr[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()

        output_filename <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(output_path, frame_id)
        frame_utils<span style="color:#f92672">.</span>writeFlowKITTI(output_filename, flow)


<span style="color:#a6e22e">@torch.no_grad</span>()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_chairs</span>(model, iters<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>):
    <span style="color:#e6db74">&#34;&#34;&#34; Perform evaluation on the FlyingChairs (test) split &#34;&#34;&#34;</span>
    model<span style="color:#f92672">.</span>eval()
    epe_list <span style="color:#f92672">=</span> []

    val_dataset <span style="color:#f92672">=</span> datasets<span style="color:#f92672">.</span>FlyingChairs(split<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;validation&#39;</span>)
    <span style="color:#75715e"># val_dataset = datasets.FlyingChairs(split=&#39;validation&#39;)</span>
    <span style="color:#66d9ef">for</span> val_id <span style="color:#f92672">in</span> tqdm(range(len(val_dataset))):
        image1, image2, flow_gt, _, frame1, frame2 <span style="color:#f92672">=</span> val_dataset[val_id]

        image1 <span style="color:#f92672">=</span> image1[None]<span style="color:#f92672">.</span>cuda()
        image2 <span style="color:#f92672">=</span> image2[None]<span style="color:#f92672">.</span>cuda()

        _, flow_pr <span style="color:#f92672">=</span> model(image1, image2, flow_gt, \
         frame1<span style="color:#f92672">=</span>frame1, frame2<span style="color:#f92672">=</span>frame2, \
         iters<span style="color:#f92672">=</span>iters, test_mode<span style="color:#f92672">=</span>True)

        <span style="color:#75715e"># viz(image1, [flow_pr, flow_gt], val_id)</span>

        epe <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>sum((flow_pr[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>cpu() <span style="color:#f92672">-</span> flow_gt)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, dim<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>sqrt()
        epe_list<span style="color:#f92672">.</span>append(epe<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>numpy())

    epe <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(np<span style="color:#f92672">.</span>concatenate(epe_list))
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Validation Chairs EPE: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> epe)
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;chairs&#39;</span>: epe}


<span style="color:#a6e22e">@torch.no_grad</span>()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_sintel</span>(model, iters<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>):
    <span style="color:#e6db74">&#34;&#34;&#34; Peform validation using the Sintel (train) split &#34;&#34;&#34;</span>
    model<span style="color:#f92672">.</span>eval()
    results <span style="color:#f92672">=</span> {}
    <span style="color:#75715e"># for dstype in [&#39;clean&#39;, &#39;final&#39;]:</span>
    feature_maps <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> dstype <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;clean&#39;</span>]:
        val_dataset <span style="color:#f92672">=</span> datasets<span style="color:#f92672">.</span>MpiSintel(split<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;training&#39;</span>, dstype<span style="color:#f92672">=</span>dstype)
        <span style="color:#75715e"># val_dataset = datasets.MpiSintel(split=&#39;test&#39;, dstype=dstype)</span>
        epe_list <span style="color:#f92672">=</span> []

        <span style="color:#66d9ef">for</span> val_id <span style="color:#f92672">in</span> tqdm(range(len(val_dataset))):
            frame1, frame2 <span style="color:#f92672">=</span> None, None

            image1, image2, flow_gt, _, frame1, frame2 <span style="color:#f92672">=</span> val_dataset[val_id]
            image1 <span style="color:#f92672">=</span> image1[None]<span style="color:#f92672">.</span>cuda()
            image2 <span style="color:#f92672">=</span> image2[None]<span style="color:#f92672">.</span>cuda()

            padder <span style="color:#f92672">=</span> InputPadder(image1<span style="color:#f92672">.</span>shape)
            image1, image2 <span style="color:#f92672">=</span> padder<span style="color:#f92672">.</span>pad(image1, image2)

            _, flow_pr, fmap1 <span style="color:#f92672">=</span> model(image1, image2, flow_gt, \
             frame1<span style="color:#f92672">=</span>frame1, frame2<span style="color:#f92672">=</span>frame2, \
             iters<span style="color:#f92672">=</span>iters, test_mode<span style="color:#f92672">=</span>True)

            feature_maps<span style="color:#f92672">.</span>append(fmap1<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy())

            flow <span style="color:#f92672">=</span> padder<span style="color:#f92672">.</span>unpad(flow_pr[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">.</span>cpu()

            epe <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>sum((flow <span style="color:#f92672">-</span> flow_gt)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, dim<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>sqrt()
            epe_list<span style="color:#f92672">.</span>append(epe<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>numpy())
            <span style="color:#66d9ef">if</span> val_id <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">900</span>:
                <span style="color:#66d9ef">break</span>

        pickle<span style="color:#f92672">.</span>dump(feature_maps, open( <span style="color:#e6db74">&#34;umap_pickles/save_900.p&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span> ))
        exit()

        epe_all <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>concatenate(epe_list)
        epe <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(epe_all)
        px1 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(epe_all<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">1</span>)
        px3 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(epe_all<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">3</span>)
        px5 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(epe_all<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">5</span>)

        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Validation (</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">) EPE: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74">, 1px: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74">, 3px: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74">, 5px: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (dstype, epe, px1, px3, px5))
        results[dstype] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(epe_list)

    <span style="color:#66d9ef">return</span> results


<span style="color:#a6e22e">@torch.no_grad</span>()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_kitti</span>(model, iters<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>):
    <span style="color:#e6db74">&#34;&#34;&#34; Peform validation using the KITTI-2015 (train) split &#34;&#34;&#34;</span>
    output_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;kitti_submission&#39;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(output_path):
        os<span style="color:#f92672">.</span>makedirs(output_path)

    model<span style="color:#f92672">.</span>eval()
    val_dataset <span style="color:#f92672">=</span> datasets<span style="color:#f92672">.</span>KITTI(split<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;training&#39;</span>)

    out_list, epe_list <span style="color:#f92672">=</span> [], []
    <span style="color:#66d9ef">for</span> val_id <span style="color:#f92672">in</span> range(len(val_dataset)):
        <span style="color:#75715e"># image1, image2, flow_gt, valid_gt = val_dataset[val_id]</span>
        image1, image2, flow_gt, valid_gt, frame1, frame2 <span style="color:#f92672">=</span> val_dataset[val_id]
        image1 <span style="color:#f92672">=</span> image1[None]<span style="color:#f92672">.</span>cuda()
        image2 <span style="color:#f92672">=</span> image2[None]<span style="color:#f92672">.</span>cuda()

        padder <span style="color:#f92672">=</span> InputPadder(image1<span style="color:#f92672">.</span>shape, mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kitti&#39;</span>)
        image1, image2 <span style="color:#f92672">=</span> padder<span style="color:#f92672">.</span>pad(image1, image2)

        flow_low, flow_pr <span style="color:#f92672">=</span> model(image1, image2, flow_gt, \
          frame1<span style="color:#f92672">=</span>frame1, frame2<span style="color:#f92672">=</span>frame2, \
          iters<span style="color:#f92672">=</span>iters, test_mode<span style="color:#f92672">=</span>True)

        flow <span style="color:#f92672">=</span> padder<span style="color:#f92672">.</span>unpad(flow_pr[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">.</span>cpu()
        viz(image1[:, :, :<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, :<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>], [flow], val_id)
        <span style="color:#75715e"># output_filename = os.path.join(output_path, str(val_id)+&#39;.flo&#39;)</span>
        <span style="color:#75715e"># frame_utils.writeFlow(output_filename, flow)</span>
        epe <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>sum((flow <span style="color:#f92672">-</span> flow_gt)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, dim<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>sqrt()
        mag <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>sum(flow_gt<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, dim<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>sqrt()

        epe <span style="color:#f92672">=</span> epe<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
        mag <span style="color:#f92672">=</span> mag<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
        val <span style="color:#f92672">=</span> valid_gt<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0.5</span>

        out <span style="color:#f92672">=</span> ((epe <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3.0</span>) <span style="color:#f92672">&amp;</span> ((epe<span style="color:#f92672">/</span>mag) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.05</span>))<span style="color:#f92672">.</span>float()
        epe_list<span style="color:#f92672">.</span>append(epe[val]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>item())
        out_list<span style="color:#f92672">.</span>append(out[val]<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy())

    epe_list <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(epe_list)
    out_list <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>concatenate(out_list)

    epe <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(epe_list)
    f1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>mean(out_list)

    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Validation KITTI: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%f</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (epe, f1))
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;kitti-epe&#39;</span>: epe, <span style="color:#e6db74">&#39;kitti-f1&#39;</span>: f1}


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--model&#39;</span>,default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/workspace/UnSupRAFT/models/raft-kitti.pth&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;restore checkpoint&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--dataset&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kitti&#39;</span> ,help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dataset for evaluation&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--small&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;use small model&#39;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--mixed_precision&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;use mixed precision&#39;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--alternate_corr&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;use efficent correlation implementation&#39;</span>)
    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()

    model <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>DataParallel(RAFT(args))
    model<span style="color:#f92672">.</span>load_state_dict(torch<span style="color:#f92672">.</span>load(args<span style="color:#f92672">.</span>model))

    model<span style="color:#f92672">.</span>cuda()
    model<span style="color:#f92672">.</span>eval()

    <span style="color:#75715e"># create_sintel_submission(model.module, warm_start=True)</span>
    <span style="color:#75715e"># create_kitti_submission(model.module)</span>

    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
        <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>dataset <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;chairs&#39;</span>:
            validate_chairs(model<span style="color:#f92672">.</span>module)

        <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>dataset <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;sintel&#39;</span>:
            validate_sintel(model<span style="color:#f92672">.</span>module)

        <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>dataset <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;kitti&#39;</span>:
            validate_kitti(model<span style="color:#f92672">.</span>module)
</code></pre></div>
    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>wuyangzz </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://wuyangzz.github.io/2021/unsupraft%E8%BF%90%E8%A1%8C/>https://wuyangzz.github.io/2021/unsupraft%E8%BF%90%E8%A1%8C/</span>
            </p>
            
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://wuyangzz.github.io/tags//">
                    #</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://wuyangzz.github.io/">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://wuyangzz.github.io/2021/arflow%E8%BF%90%E4%BD%9C%E6%AD%A5%E9%AA%A4/" class="prev" rel="prev" title="ARflow运作步骤"><i class="iconfont icon-left"></i>&nbsp;ARflow运作步骤</a>
         
        
        <a href="https://wuyangzz.github.io/2021/dicom%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/" class="next" rel="next" title="Dicom文件处理">Dicom文件处理&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2020 - 2022</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://wuyangzz.github.io/">wuyangzz</a> | </span> 
         

         
	<span>Powered by <a href="https://github.com/wuyangzz/" target="_blank" rel="external nofollow">wuyangzz</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span>     </div>
</footer>
<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>











    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
