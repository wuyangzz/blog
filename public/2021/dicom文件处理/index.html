<!DOCTYPE html>
<html lang="zh-cn">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="wuyangzz">
  
  
  
  <link rel="prev" href="https://wuyangzz.github.io/2021/unsupraft%E8%BF%90%E8%A1%8C/" />
  <link rel="next" href="https://wuyangzz.github.io/2022/resume/" />
  <link rel="canonical" href="https://wuyangzz.github.io/2021/dicom%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           Dicom文件处理 | wuyangzz
       
  </title>
  <meta name="title" content="Dicom文件处理 | wuyangzz">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/wuyangzz.github.io\/"
    },
    "articleSection" : "posts",
    "name" : "Dicom文件处理",
    "headline" : "Dicom文件处理",
    "description" : "使用阈值去掉杂乱的信息 import cv2 import os import pydicom import numpy as np # dicom图像输入路径 inputdir = \u0026#39;\/workspace\/20210910\/Bmodel\/inputs\u0026#39; # dicom图像输出路径 outdir = \u0026#39;\/workspace\/20210910\/Bmodel\/max_contours_images\/\u0026#39; # 获取文件夹下文件列表 files_name_list=os.listdir(inputdir) count=0 # 遍历所有文件 def findMaxcontours(data): _, binaryzation = cv2.threshold(data, 2, 255, cv2.THRESH_BINARY_INV) binaryzation = np.uint8(binaryzation) # 找到所有的轮廓 contours, _ = cv2.findContours( binaryzation, cv2.RETR_TREE, cv2.CHAIN_APPROX_NONE) area = [] # 找到最大的轮廓 实际应该为第二大轮廓 for k in range(len(contours)): area.append(cv2.contourArea(contours[k])) # max_idx = np.argmax(np.array(area)) max_idx = np.argsort(np.array(area))[-2] # cv2.fillContexPoly(mask[i], contours[max_idx], 0) # 填充最大的轮廓 mask = cv2.",
    "inLanguage" : "zh-cn",
    "author" : "wuyangzz",
    "creator" : "wuyangzz",
    "publisher": "wuyangzz",
    "accountablePerson" : "wuyangzz",
    "copyrightHolder" : "wuyangzz",
    "copyrightYear" : "2021",
    "datePublished": "2021-10-09 10:17:39 \u002b0800 CST",
    "dateModified" : "2021-10-09 10:17:39 \u002b0800 CST",
    "url" : "https:\/\/wuyangzz.github.io\/2021\/dicom%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86\/",
    "wordCount" : "1372",
    "keywords" : [ "", "wuyangzz"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://wuyangzz.github.io/">wuyangzz</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">博客</a>
                
                <a class="menu-item" href="/categories/" title="">分类</a>
                
                <a class="menu-item" href="/tags/" title="">标签</a>
                
                <a class="menu-item" href="/about/" title="关于我">关于我</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://wuyangzz.github.io/">wuyangzz</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">博客</a>
                
                <a class="menu-item" href="/categories/" title="">分类</a>
                
                <a class="menu-item" href="/tags/" title="">标签</a>
                
                <a class="menu-item" href="/about/" title="关于我">关于我</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Dicom文件处理</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://wuyangzz.github.io/" rel="author">wuyangzz</a> with ♥ 
                <span class="post-time">
                on <time datetime=2021-10-09 itemprop="datePublished">October 9, 2021</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://wuyangzz.github.io/categories/">  </a>
                        
                </span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <h1 id="使用阈值去掉杂乱的信息">使用阈值去掉杂乱的信息</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> cv2
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> pydicom
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#75715e"># dicom图像输入路径</span>
inputdir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/20210910/Bmodel/inputs&#39;</span>
<span style="color:#75715e"># dicom图像输出路径</span>
outdir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/20210910/Bmodel/max_contours_images/&#39;</span>

<span style="color:#75715e"># 获取文件夹下文件列表</span>
files_name_list<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>listdir(inputdir)
count<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#75715e"># 遍历所有文件</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">findMaxcontours</span>(data):
    _, binaryzation <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>threshold(data, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">255</span>,
                                    cv2<span style="color:#f92672">.</span>THRESH_BINARY_INV)
    binaryzation <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>uint8(binaryzation)
    <span style="color:#75715e"># 找到所有的轮廓</span>
    contours, _ <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>findContours(
        binaryzation, cv2<span style="color:#f92672">.</span>RETR_TREE, cv2<span style="color:#f92672">.</span>CHAIN_APPROX_NONE)
    area <span style="color:#f92672">=</span> []
    <span style="color:#75715e"># 找到最大的轮廓 实际应该为第二大轮廓</span>
    <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> range(len(contours)):
        area<span style="color:#f92672">.</span>append(cv2<span style="color:#f92672">.</span>contourArea(contours[k]))
    <span style="color:#75715e"># max_idx = np.argmax(np.array(area))</span>
    max_idx <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argsort(np<span style="color:#f92672">.</span>array(area))[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>]
    <span style="color:#75715e"># cv2.fillContexPoly(mask[i], contours[max_idx], 0)</span>
    <span style="color:#75715e"># 填充最大的轮廓</span>
    mask <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>drawContours(np<span style="color:#f92672">.</span>zeros(data<span style="color:#f92672">.</span>shape), contours,
                            max_idx, <span style="color:#ae81ff">1</span>, cv2<span style="color:#f92672">.</span>FILLED)

    image1 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>multiply(mask, data)
    image1 <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>cvtColor(np<span style="color:#f92672">.</span>uint8(image1), cv2<span style="color:#f92672">.</span>COLOR_GRAY2BGR)
    <span style="color:#66d9ef">return</span> image1

<span style="color:#66d9ef">for</span> file_name <span style="color:#f92672">in</span> files_name_list:
    path<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(inputdir,file_name)
    ds<span style="color:#f92672">=</span>pydicom<span style="color:#f92672">.</span>read_file(path)
    <span style="color:#75715e"># 获取该文件的帧数</span>
    num_frame<span style="color:#f92672">=</span>ds<span style="color:#f92672">.</span>pixel_array<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
    <span style="color:#75715e"># 逐帧保存为PNG无损图像</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_frame):
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            image1 <span style="color:#f92672">=</span> findMaxcontours(ds<span style="color:#f92672">.</span>pixel_array[i, :, :])
        <span style="color:#66d9ef">else</span>:
            image2 <span style="color:#f92672">=</span> findMaxcontours(ds<span style="color:#f92672">.</span>pixel_array[i, :, :])
            cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir, str(
                count)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_1.png&#34;</span>), image1, [cv2<span style="color:#f92672">.</span>IMWRITE_PNG_COMPRESSION, <span style="color:#ae81ff">0</span>])
            cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir, str(
                count)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_2.png&#34;</span>), image2, [cv2<span style="color:#f92672">.</span>IMWRITE_PNG_COMPRESSION, <span style="color:#ae81ff">0</span>])
            image1<span style="color:#f92672">=</span>image2
            count<span style="color:#f92672">+=</span><span style="color:#ae81ff">1</span>

</code></pre></div><p>dicom处理为tf train数据格式</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> cv2
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> pydicom
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> tensorflow <span style="color:#f92672">as</span> tf

<span style="color:#f92672">import</span> conversion_utils




<span style="color:#75715e"># 遍历所有文件</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_data_example</span>(record_writer, image1, image2):
    <span style="color:#e6db74">&#34;&#34;&#34;Write data example to disk.&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">assert</span> image1<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> image2<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
    <span style="color:#66d9ef">assert</span> image1<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> image2<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]
    <span style="color:#75715e"># assert image1.shape[2] == image2.shape[2]</span>

    feature <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;height&#39;</span>: conversion_utils<span style="color:#f92672">.</span>int64_feature(image1<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]),
        <span style="color:#e6db74">&#39;width&#39;</span>: conversion_utils<span style="color:#f92672">.</span>int64_feature(image1<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]),
    }
    example <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>SequenceExample(
        context<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>Features(feature<span style="color:#f92672">=</span>feature),
        feature_lists<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>FeatureLists(
            feature_list<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#39;images&#39;</span>:
                    tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>FeatureList(feature<span style="color:#f92672">=</span>[
                        conversion_utils<span style="color:#f92672">.</span>bytes_feature(
                            image1<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;uint8&#39;</span>)<span style="color:#f92672">.</span>tobytes()),
                        conversion_utils<span style="color:#f92672">.</span>bytes_feature(
                            image2<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;uint8&#39;</span>)<span style="color:#f92672">.</span>tobytes())
                    ]),
            }))
    record_writer<span style="color:#f92672">.</span>write(example<span style="color:#f92672">.</span>SerializeToString())


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">findMaxcontours</span>(data):
    _, binaryzation <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>threshold(data, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">255</span>,
                                    cv2<span style="color:#f92672">.</span>THRESH_BINARY_INV)
    binaryzation <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>uint8(binaryzation)
    <span style="color:#75715e"># 找到所有的轮廓</span>
    contours, _ <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>findContours(
        binaryzation, cv2<span style="color:#f92672">.</span>RETR_TREE, cv2<span style="color:#f92672">.</span>CHAIN_APPROX_NONE)
    area <span style="color:#f92672">=</span> []
    <span style="color:#75715e"># 找到最大的轮廓 实际应该为第二大轮廓</span>
    <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> range(len(contours)):
        area<span style="color:#f92672">.</span>append(cv2<span style="color:#f92672">.</span>contourArea(contours[k]))
    <span style="color:#75715e"># max_idx = np.argmax(np.array(area))</span>
    max_idx <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argsort(np<span style="color:#f92672">.</span>array(area))[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>]
    <span style="color:#75715e"># cv2.fillContexPoly(mask[i], contours[max_idx], 0)</span>
    <span style="color:#75715e"># 填充最大的轮廓</span>
    mask <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>drawContours(np<span style="color:#f92672">.</span>zeros(data<span style="color:#f92672">.</span>shape), contours,
                            max_idx, <span style="color:#ae81ff">1</span>, cv2<span style="color:#f92672">.</span>FILLED)

    image1 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>multiply(mask, data)
    image1 <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>cvtColor(np<span style="color:#f92672">.</span>uint8(image1), cv2<span style="color:#f92672">.</span>COLOR_GRAY2BGR)
    <span style="color:#66d9ef">return</span> image1





<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    <span style="color:#75715e"># dicom图像输入路径</span>
    inputdir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/20210910/Bmodel/inputs&#39;</span>
    <span style="color:#75715e"># dicom图像输出路径</span>
    outdir_tfcard <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/20210910/Bmodel/max_contours_tfcard_size512*512_间隔1帧_RGB&#39;</span>
    outdir_image <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/20210910/Bmodel/max_contours_images_size512*512_间隔1帧_RGB&#39;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>exists(outdir_tfcard):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Making new tfcard directory&#39;</span>, outdir_tfcard)
        tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>makedirs(outdir_tfcard)
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>exists(outdir_image):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Making new image directory&#39;</span>, outdir_image)
        tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>makedirs(outdir_image)
    filename <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir_tfcard, <span style="color:#e6db74">&#39;fdicom@1&#39;</span>)
    files_name_list <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(inputdir)
    count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>TFRecordWriter(filename) <span style="color:#66d9ef">as</span> record_writer:
        <span style="color:#66d9ef">for</span> file_name <span style="color:#f92672">in</span> files_name_list:
            <span style="color:#75715e"># 获取文件夹下文件列表</span>
            path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(inputdir, file_name)
            ds <span style="color:#f92672">=</span> pydicom<span style="color:#f92672">.</span>read_file(path)
            <span style="color:#75715e"># 获取该文件的帧数</span>
            num_frame <span style="color:#f92672">=</span> ds<span style="color:#f92672">.</span>pixel_array<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Read a new dicom file: &#39;</span> <span style="color:#f92672">+</span> file_name <span style="color:#f92672">+</span>
                                      <span style="color:#e6db74">&#34;      frame: </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span>, num_frame)
            ds1 <span style="color:#f92672">=</span> ds<span style="color:#f92672">.</span>pixel_array[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
            ds2 <span style="color:#f92672">=</span> ds<span style="color:#f92672">.</span>pixel_array[<span style="color:#ae81ff">1</span>:]
            <span style="color:#75715e"># 逐帧保存为PNG无损图像</span>
            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(ds1<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]):
                image1 <span style="color:#f92672">=</span> findMaxcontours(ds1[i, :, :])
                image2 <span style="color:#f92672">=</span> findMaxcontours(ds2[i, :, :])
                image1<span style="color:#f92672">=</span>image1[<span style="color:#ae81ff">60</span>:<span style="color:#ae81ff">572</span>, <span style="color:#ae81ff">114</span>:<span style="color:#ae81ff">626</span>, :]
                image2<span style="color:#f92672">=</span>image2[<span style="color:#ae81ff">60</span>:<span style="color:#ae81ff">572</span>, <span style="color:#ae81ff">114</span>:<span style="color:#ae81ff">626</span>, :]
                cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir_image, str(
                    count)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_1.png&#34;</span>), image1, [cv2<span style="color:#f92672">.</span>IMWRITE_PNG_COMPRESSION, <span style="color:#ae81ff">0</span>])
                cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir_image, str(
                    count)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_2.png&#34;</span>), image2, [cv2<span style="color:#f92672">.</span>IMWRITE_PNG_COMPRESSION, <span style="color:#ae81ff">0</span>])
                write_data_example(record_writer, image1, image2)
                count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Read a new frame: </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>, count)

</code></pre></div><p>20211012修改版本</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> cv2
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> pydicom
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> tensorflow <span style="color:#f92672">as</span> tf

<span style="color:#f92672">import</span> conversion_utils
<span style="color:#f92672">import</span> tensorflow <span style="color:#f92672">as</span> tf
<span style="color:#f92672">from</span> tensorflow <span style="color:#f92672">import</span> keras

<span style="color:#75715e"># 遍历所有文件</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_data_example</span>(record_writer, image1, image2):
    <span style="color:#e6db74">&#34;&#34;&#34;Write data example to disk.&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">assert</span> image1<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> image2<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
    <span style="color:#66d9ef">assert</span> image1<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> image2<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]
    <span style="color:#75715e"># assert image1.shape[2] == image2.shape[2]</span>

    feature <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;height&#39;</span>: conversion_utils<span style="color:#f92672">.</span>int64_feature(image1<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]),
        <span style="color:#e6db74">&#39;width&#39;</span>: conversion_utils<span style="color:#f92672">.</span>int64_feature(image1<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]),
    }
    example <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>SequenceExample(
        context<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>Features(feature<span style="color:#f92672">=</span>feature),
        feature_lists<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>FeatureLists(
            feature_list<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#39;images&#39;</span>:
                    tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>FeatureList(feature<span style="color:#f92672">=</span>[
                        conversion_utils<span style="color:#f92672">.</span>bytes_feature(
                            image1<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;uint8&#39;</span>)<span style="color:#f92672">.</span>tobytes()),
                        conversion_utils<span style="color:#f92672">.</span>bytes_feature(
                            image2<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;uint8&#39;</span>)<span style="color:#f92672">.</span>tobytes())
                    ]),
            }))
    record_writer<span style="color:#f92672">.</span>write(example<span style="color:#f92672">.</span>SerializeToString())


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">findMaxcontours_mask</span>(data):
    _, binaryzation <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>threshold(data<span style="color:#f92672">*</span><span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">255</span>,
                                    cv2<span style="color:#f92672">.</span>THRESH_BINARY_INV)
    binaryzation <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>uint8(binaryzation)
    <span style="color:#75715e"># 找到所有的轮廓</span>
    contours, _ <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>findContours(
        binaryzation, cv2<span style="color:#f92672">.</span>RETR_TREE, cv2<span style="color:#f92672">.</span>CHAIN_APPROX_NONE)
    area <span style="color:#f92672">=</span> []
    <span style="color:#75715e"># 找到最大的轮廓 实际应该为第二大轮廓</span>
    <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> range(len(contours)):
        area<span style="color:#f92672">.</span>append(cv2<span style="color:#f92672">.</span>contourArea(contours[k]))
    <span style="color:#75715e"># max_idx = np.argmax(np.array(area))</span>
    max_idx <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argsort(np<span style="color:#f92672">.</span>array(area))[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>]
    <span style="color:#75715e"># cv2.fillContexPoly(mask[i], contours[max_idx], 0)</span>
    <span style="color:#75715e"># 填充最大的轮廓</span>
    mask <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>drawContours(np<span style="color:#f92672">.</span>zeros(data<span style="color:#f92672">.</span>shape), contours,
                            max_idx, <span style="color:#ae81ff">1</span>, cv2<span style="color:#f92672">.</span>FILLED)

    <span style="color:#66d9ef">return</span> mask


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">findMaxcontours_raw</span>(data):
    _, binaryzation <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>threshold(data, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">255</span>,
                                    cv2<span style="color:#f92672">.</span>THRESH_BINARY_INV)
    binaryzation <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>uint8(binaryzation)
    <span style="color:#75715e"># 找到所有的轮廓</span>
    contours, _ <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>findContours(
        binaryzation, cv2<span style="color:#f92672">.</span>RETR_TREE, cv2<span style="color:#f92672">.</span>CHAIN_APPROX_NONE)
    area <span style="color:#f92672">=</span> []
    <span style="color:#75715e"># 找到最大的轮廓 实际应该为第二大轮廓</span>
    <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> range(len(contours)):
        area<span style="color:#f92672">.</span>append(cv2<span style="color:#f92672">.</span>contourArea(contours[k]))
    max_idx <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmax(np<span style="color:#f92672">.</span>array(area))
    <span style="color:#75715e"># max_idx = np.argsort(np.array(area))[-2]</span>
    <span style="color:#75715e"># cv2.fillContexPoly(mask[i], contours[max_idx], 0)</span>
    <span style="color:#75715e"># 填充最大的轮廓</span>
    mask <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>drawContours(np<span style="color:#f92672">.</span>ones(data<span style="color:#f92672">.</span>shape), contours,
                            max_idx, <span style="color:#ae81ff">0</span>, cv2<span style="color:#f92672">.</span>FILLED)

    image <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>multiply(mask, data)
    <span style="color:#66d9ef">return</span> image

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    <span style="color:#75715e"># dicom图像输入路径</span>
    inputdir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/20210910/Bmodel/inputs&#39;</span>
    <span style="color:#75715e"># dicom图像输出路径</span>
    <span style="color:#75715e"># outdir_tfcard_unet = &#39;/workspace/20210910/datasets/512_512_tf_UNET&#39;</span>
    <span style="color:#75715e"># outdir_tfcard_raw = &#39;/workspace/20210910/datasets/512_512_tf_RAW&#39;</span>
    <span style="color:#75715e"># outdir_image_unet = &#39;/workspace/20210910/datasets/512_512_image_UNET&#39;</span>
    <span style="color:#75715e"># outdir_image_raw = &#39;/workspace/20210910/datasets/512_512_image_RAW&#39;</span>
    outdir_tfcard_unet <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/20210910/datasets/480_384_tf_UNET&#39;</span>
    outdir_tfcard_raw <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/20210910/datasets/480_384_tf_RAW&#39;</span>
    outdir_image_unet <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/20210910/datasets/480_384_image_UNET&#39;</span>
    outdir_image_raw <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/20210910/datasets/480_384_image_RAW&#39;</span>
    model_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/workspace/my-unet3plus/model/图像大小320使用crop进行训练/model&#39;</span>
    model_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">320</span>
    <span style="color:#75715e"># 检查输出文件夹</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>exists(outdir_tfcard_unet):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Making new tfcard directory&#39;</span>, outdir_tfcard_unet)
        tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>makedirs(outdir_tfcard_unet)
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>exists(outdir_tfcard_raw):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Making new image directory&#39;</span>, outdir_tfcard_raw)
        tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>makedirs(outdir_tfcard_raw)
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>exists(outdir_image_unet):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Making new tfcard directory&#39;</span>, outdir_image_unet)
        tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>makedirs(outdir_image_unet)
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>exists(outdir_image_raw):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Making new image directory&#39;</span>, outdir_image_raw)
        tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>makedirs(outdir_image_raw)
    
    tfcard_unet_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir_tfcard_unet, <span style="color:#e6db74">&#39;tfcard_unet@1&#39;</span>)
    tfcard_raw_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir_tfcard_raw, <span style="color:#e6db74">&#39;tfcard_raw@1&#39;</span>)
    dicom_files_list <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(inputdir)
    count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#e6db74">&#39;&#39;&#39;导入模型&#39;&#39;&#39;</span>
    os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;CUDA_VISIBLE_DEVICES&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0&#34;</span>
    unet3plus <span style="color:#f92672">=</span> keras<span style="color:#f92672">.</span>models<span style="color:#f92672">.</span>load_model(model_path, compile<span style="color:#f92672">=</span>False)
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>TFRecordWriter(tfcard_unet_dir) <span style="color:#66d9ef">as</span> record_writer_unet:
        <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>TFRecordWriter(tfcard_raw_dir) <span style="color:#66d9ef">as</span> record_writer_raw:
            <span style="color:#66d9ef">for</span> dicom_file <span style="color:#f92672">in</span> dicom_files_list:
                <span style="color:#75715e"># 获取文件夹下文件列表</span>
                dicom_file_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(inputdir, dicom_file)
                ds_dicom <span style="color:#f92672">=</span> pydicom<span style="color:#f92672">.</span>read_file(dicom_file_dir)
                <span style="color:#75715e"># 获取该文件的帧数</span>
                num_frame <span style="color:#f92672">=</span> ds_dicom<span style="color:#f92672">.</span>pixel_array<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
                <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;读取dicom文件: &#39;</span> <span style="color:#f92672">+</span> dicom_file <span style="color:#f92672">+</span>
                    <span style="color:#e6db74">&#34;      数量为: </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span>, num_frame)
                <span style="color:#75715e"># 图像大小 51 2* 512</span>
                <span style="color:#75715e"># images_read = ds_dicom.pixel_array[:, 60:572, 114:626]</span>
                <span style="color:#75715e"># 图像大小为480*384</span>
                images_read <span style="color:#f92672">=</span> ds_dicom<span style="color:#f92672">.</span>pixel_array[:, <span style="color:#ae81ff">68</span>:<span style="color:#ae81ff">548</span>, <span style="color:#ae81ff">238</span>:<span style="color:#ae81ff">622</span>]
                <span style="color:#75715e"># 整理图像</span>
                _, h, w <span style="color:#f92672">=</span> images_read<span style="color:#f92672">.</span>shape
                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(images_read<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]):
                    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
                        images <span style="color:#f92672">=</span> findMaxcontours_raw(images_read[i, :, :])<span style="color:#f92672">.</span>reshape(
                            <span style="color:#ae81ff">1</span>, h, w)
                    <span style="color:#66d9ef">else</span>:
                        images <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>append(images, findMaxcontours_raw(
                            images_read[i, :, :])<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>, h, w), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
                <span style="color:#75715e"># resize 图像好作为模型输入</span>
                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(images<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]):
                    <span style="color:#66d9ef">if</span> i<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>:
                        resize_images <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>resize(
                            images[i, :, :], (model_size, model_size), 
                            interpolation<span style="color:#f92672">=</span>cv2<span style="color:#f92672">.</span>INTER_AREA)<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>, model_size, model_size)
                    <span style="color:#66d9ef">else</span>:
                        resize_images <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>append(resize_images, cv2<span style="color:#f92672">.</span>resize(
                            images[i, :, :], (model_size, model_size),
                            interpolation<span style="color:#f92672">=</span>cv2<span style="color:#f92672">.</span>INTER_AREA)<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>, model_size, model_size), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
                <span style="color:#75715e"># 预测图像</span>
                resize_mask <span style="color:#f92672">=</span> unet3plus<span style="color:#f92672">.</span>predict([(resize_images <span style="color:#f92672">/</span> <span style="color:#ae81ff">255</span>)<span style="color:#f92672">.</span>reshape(
                    images<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], model_size, model_size, <span style="color:#ae81ff">1</span>)],
                    batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>reshape(
                    images<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], model_size,
                    model_size)
                <span style="color:#75715e"># 整理预测后的图像并且从新resize为原大小</span>
                resize_mask <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>uint8(resize_mask<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.3</span>)
                _, h, w <span style="color:#f92672">=</span> images<span style="color:#f92672">.</span>shape
                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(images<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]):
                    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
                        masks <span style="color:#f92672">=</span> findMaxcontours_mask(cv2<span style="color:#f92672">.</span>resize(
                            resize_mask[i, :, :], (w, h),
                            interpolation<span style="color:#f92672">=</span>cv2<span style="color:#f92672">.</span>INTER_NEAREST))<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>, h, w)
                    <span style="color:#66d9ef">else</span>:
                        masks <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>append(masks, findMaxcontours_mask(cv2<span style="color:#f92672">.</span>resize(
                            resize_mask[i, :, :], (w, h),
                            interpolation<span style="color:#f92672">=</span>cv2<span style="color:#f92672">.</span>INTER_NEAREST))<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>, h, w), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
                <span style="color:#75715e"># 划分图像</span>
                images_1, images_2 <span style="color:#f92672">=</span> images[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], images[<span style="color:#ae81ff">1</span>:]
                masks_1, masks_2 <span style="color:#f92672">=</span> masks[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],masks[<span style="color:#ae81ff">1</span>:]
                <span style="color:#75715e"># 逐帧保存为PNG无损图像</span>
                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(images_1<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]):
                    image1, image2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>uint8(images_1[i,:, :]), np<span style="color:#f92672">.</span>uint8(images_2[i, :, :])
                    mask1, mask2 <span style="color:#f92672">=</span> masks_1[i, :, :], masks_2[i, :, :]
                    <span style="color:#75715e"># 膨胀运算</span>
                    kernel_2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>ones((<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span>), dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>uint8)
                    mask1, mask2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>uint8(cv2<span style="color:#f92672">.</span>dilate(
                        mask1, kernel_2, <span style="color:#ae81ff">1</span>)), np<span style="color:#f92672">.</span>uint8(cv2<span style="color:#f92672">.</span>dilate(mask2, kernel_2, <span style="color:#ae81ff">1</span>))
                    <span style="color:#75715e"># 进行叠加</span>
                    mask_1_2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>uint8(np<span style="color:#f92672">.</span>add(mask1, mask2) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.9</span>)
                    mask1_sum, mask2_sum, mask_1_2_sum <span style="color:#f92672">=</span> mask1<span style="color:#f92672">.</span>sum(), mask2<span style="color:#f92672">.</span>sum(), mask_1_2<span style="color:#f92672">.</span>sum()

                    <span style="color:#66d9ef">if</span> mask1_sum <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">13000</span> <span style="color:#f92672">or</span> mask2_sum <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">13000</span> <span style="color:#f92672">or</span> mask_1_2_sum<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">13000</span>:
                        <span style="color:#66d9ef">continue</span>
                    <span style="color:#66d9ef">else</span>:
                        image1_unet <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>multiply(
                            image1, mask_1_2)
                        image2_unet <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>multiply(
                            image2, mask_1_2)
                        <span style="color:#75715e"># 保存原图</span>
                        cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir_image_raw, str(
                            count)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_1.png&#34;</span>), image1, [cv2<span style="color:#f92672">.</span>IMWRITE_PNG_COMPRESSION, <span style="color:#ae81ff">0</span>])
                        cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir_image_raw, str(
                            count)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_2.png&#34;</span>), image2, [cv2<span style="color:#f92672">.</span>IMWRITE_PNG_COMPRESSION, <span style="color:#ae81ff">0</span>])
                        image1<span style="color:#f92672">=</span>cv2<span style="color:#f92672">.</span>cvtColor(
                            np<span style="color:#f92672">.</span>uint8(image1), cv2<span style="color:#f92672">.</span>COLOR_GRAY2BGR)
                        image2 <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>cvtColor(
                            np<span style="color:#f92672">.</span>uint8(image2), cv2<span style="color:#f92672">.</span>COLOR_GRAY2BGR)
                        write_data_example(record_writer_raw, image1, image2)
                        <span style="color:#75715e"># 保存unet图</span>
                        cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir_image_unet, str(
                            count)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_1.png&#34;</span>), image1_unet, [cv2<span style="color:#f92672">.</span>IMWRITE_PNG_COMPRESSION, <span style="color:#ae81ff">0</span>])
                        cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(outdir_image_unet, str(
                            count)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_2.png&#34;</span>), image2_unet, [cv2<span style="color:#f92672">.</span>IMWRITE_PNG_COMPRESSION, <span style="color:#ae81ff">0</span>])
                        image1_unet <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>cvtColor(
                            np<span style="color:#f92672">.</span>uint8(image1_unet), cv2<span style="color:#f92672">.</span>COLOR_GRAY2BGR)
                        image2_unet <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>cvtColor(
                            np<span style="color:#f92672">.</span>uint8(image2_unet), cv2<span style="color:#f92672">.</span>COLOR_GRAY2BGR)
                        write_data_example(
                            record_writer_unet, image1_unet, image2_unet)
                        count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

                <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;总对数为: </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>, count)

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> glob <span style="color:#f92672">import</span> glob
<span style="color:#f92672">from</span> tensorflow <span style="color:#f92672">import</span> keras
<span style="color:#f92672">from</span> tensorflow.keras.layers <span style="color:#f92672">import</span> Input, Conv2D, Dropout, Activation, UpSampling2D, GlobalMaxPooling2D, multiply
<span style="color:#f92672">from</span> tensorflow.keras.backend <span style="color:#f92672">import</span> max
<span style="color:#f92672">from</span> tensorflow.python.ops.math_ops <span style="color:#f92672">import</span> to_int32
<span style="color:#f92672">from</span> keras_unet_collection <span style="color:#f92672">import</span> models, base, utils
<span style="color:#f92672">from</span> keras_unet_collection <span style="color:#f92672">import</span> losses
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> cv2
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;CUDA_VISIBLE_DEVICES&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0&#34;</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plot_un</span>(resize_img, resize_mask, plot_dir, name):
    <span style="color:#75715e"># 保存resize后的数据</span>
    fig_height, fig_width<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">6</span>
    plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(fig_width <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>, fig_height <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span>))
    plt<span style="color:#f92672">.</span>subplot(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span>)
    plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;RESIZE_IMG&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
    plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
    plt<span style="color:#f92672">.</span>imshow(resize_img, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gray&#39;</span>)
    plt<span style="color:#f92672">.</span>subplot(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">2</span>)
    plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
    plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;MASK_IMG&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
    plt<span style="color:#f92672">.</span>imshow(resize_mask, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gray&#39;</span>)

    plt<span style="color:#f92672">.</span>subplot(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>)
    plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
    resize_img_copy<span style="color:#f92672">=</span>resize_img<span style="color:#f92672">.</span>copy()
    _, resize_mask_1<span style="color:#f92672">=</span>cv2<span style="color:#f92672">.</span>threshold(resize_mask, <span style="color:#ae81ff">125</span>, <span style="color:#ae81ff">255</span>,
                                    cv2<span style="color:#f92672">.</span>THRESH_BINARY_INV)
    <span style="color:#75715e"># gray = cv2.cvtColor(resize_mask, cv2.COLOR_BGR2GRAY)</span>
    resize_mask_1<span style="color:#f92672">=</span>resize_mask_1<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8)
    contours, _<span style="color:#f92672">=</span>cv2<span style="color:#f92672">.</span>findContours(
        resize_mask_1, cv2<span style="color:#f92672">.</span>RETR_TREE, cv2<span style="color:#f92672">.</span>CHAIN_APPROX_NONE)
    area<span style="color:#f92672">=</span>[]
    <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> range(len(contours)):
        area<span style="color:#f92672">.</span>append(cv2<span style="color:#f92672">.</span>contourArea(contours[k]))
    <span style="color:#75715e"># max_idx = np.argmax(np.array(area))</span>
    max_idx <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argsort(np<span style="color:#f92672">.</span>array(area))[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>]

    cv2<span style="color:#f92672">.</span>drawContours(resize_img_copy, contours,
                        max_idx, <span style="color:#ae81ff">255</span>, thickness<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
    plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;IMG&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
    plt<span style="color:#f92672">.</span>imshow(resize_img_copy, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gray&#39;</span>)
    plt<span style="color:#f92672">.</span>savefig(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(plot_dir, name),
                bbox_inches<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;tight&#39;</span>, pad_inches<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>, dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>)
    plt<span style="color:#f92672">.</span>close()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plot_image</span>(raw_img,resize_img,resize_mask,plot_dir,id):
    <span style="color:#75715e"># 保存原始数据</span>
    <span style="color:#66d9ef">if</span> resize_mask<span style="color:#f92672">.</span>sum()<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">1300000</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(plot_dir, str(id)))
        <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(plot_dir)):
        os<span style="color:#f92672">.</span>makedirs(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(plot_dir))
    cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(plot_dir, str(id)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_原图.png&#34;</span>), raw_img)
    cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(plot_dir, str(
        id)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_resize.png&#34;</span>), resize_img)
    cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(plot_dir, str(id)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_mask.png&#34;</span>),
                resize_mask)
    mask_resize_int <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>uint8(cv2<span style="color:#f92672">.</span>resize(
        resize_mask, (raw_img<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>], raw_img<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">125</span>)
    cv2<span style="color:#f92672">.</span>imwrite(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(plot_dir, str(id)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_unet.png&#34;</span>),
                np<span style="color:#f92672">.</span>multiply(raw_img, mask_resize_int))
    <span style="color:#75715e"># cv2.imwrite()</span>
    <span style="color:#66d9ef">try</span>:
        plot_un(resize_img, resize_mask, plot_dir, str(id)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_resize_predict.png&#34;</span>)
        plot_un(raw_img, cv2<span style="color:#f92672">.</span>resize(resize_mask, (raw_img<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>], raw_img<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])),
            plot_dir, str(id)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_predict.png&#34;</span>)
    <span style="color:#66d9ef">except</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>plot_dir<span style="color:#f92672">+</span>str(id)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_predict.png&#34;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict_dataset</span>(dataset_folder):
    images <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(dataset_folder)
    <span style="color:#75715e"># images = [_ for _ in os.listdir(dataset_folder) if _.endswith(&#34;_1.png&#34;)]</span>
    images <span style="color:#f92672">=</span> [os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(dataset_folder, i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> images]
    images <span style="color:#f92672">=</span> sorted(images,
                    key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x: int(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>basename(x)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#ae81ff">0</span>]))
    <span style="color:#66d9ef">for</span> image <span style="color:#f92672">in</span> images:
        image <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imread(image, <span style="color:#ae81ff">0</span>)
        <span style="color:#66d9ef">yield</span> image


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict_main</span>(dataset_folder, model_folder, model_image_size, plot_folder):
    model <span style="color:#f92672">=</span> keras<span style="color:#f92672">.</span>models<span style="color:#f92672">.</span>load_model(model_folder, compile<span style="color:#f92672">=</span>False)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Start Predict &#34;</span><span style="color:#f92672">+</span>plot_folder)
    <span style="color:#66d9ef">for</span> i, image <span style="color:#f92672">in</span> enumerate(predict_dataset(dataset_folder)):
        sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(f<span style="color:#e6db74">&#39;{i},&#39;</span>)
        sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>flush()
        image_resize <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>resize(image, (model_image_size, model_image_size))
        infer_mask <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(
            (image_resize <span style="color:#f92672">/</span> <span style="color:#ae81ff">255</span>)<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>, image_resize<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>],
                                         image_resize<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">1</span>))[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
        <span style="color:#75715e"># cv2.imwrite(os.path.join(plot_folder, str(i)+&#34;_原图.png&#34;), image)</span>
        <span style="color:#75715e"># cv2.imwrite(os.path.join(plot_folder, str(</span>
        <span style="color:#75715e">#     i)+&#34;_resize.png&#34;), image_resize)</span>
        <span style="color:#75715e"># cv2.imwrite(os.path.join(plot_folder, str(i)+&#34;_mask.png&#34;),</span>
        <span style="color:#75715e">#             infer_mask[0, :, :, 0]*255)</span>
        plot_image(image, image_resize,
                   infer_mask[<span style="color:#ae81ff">0</span>, :, :, <span style="color:#ae81ff">0</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">255</span>, plot_folder, i)
        
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;End Predict&#34;</span>)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    dataset_folder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0010&#34;</span>
    model_folder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/workspace/my-unet3plus/model/图像大小320使用crop进行训练/model&#34;</span>
    plot_folder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0010_UNET&#34;</span>
    model_image_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">320</span>
    <span style="color:#75715e"># predict_main(dataset_folder, model_folder, model_image_size, plot_folder)</span>
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0009&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0009_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0010&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0010_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0011&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0011_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0112&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0112_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0113&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0113_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0114&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0114_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0115&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0115_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0158&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0158_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0159&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0159_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0160&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0160_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0161&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0161_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0163&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0163_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0165&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0165_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0166&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0166_UNET&#34;</span>)
    predict_main(<span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0167&#34;</span>,
                 model_folder, model_image_size, <span style="color:#e6db74">&#34;/workspace/20210910/Bmodel/直接crop为512*512灰度图像/IM_0167_UNET&#34;</span>)
</code></pre></div>
    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>wuyangzz </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://wuyangzz.github.io/2021/dicom%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/>https://wuyangzz.github.io/2021/dicom%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/</span>
            </p>
            
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://wuyangzz.github.io/tags//">
                    #</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://wuyangzz.github.io/">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://wuyangzz.github.io/2021/unsupraft%E8%BF%90%E8%A1%8C/" class="prev" rel="prev" title="UnSupRAFT运行"><i class="iconfont icon-left"></i>&nbsp;UnSupRAFT运行</a>
         
        
        <a href="https://wuyangzz.github.io/2022/resume/" class="next" rel="next" title="Resume">Resume&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2020 - 2022</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://wuyangzz.github.io/">wuyangzz</a> | </span> 
         

         
	<span>Powered by <a href="https://github.com/wuyangzz/" target="_blank" rel="external nofollow">wuyangzz</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span>     </div>
</footer>
<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>











    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
